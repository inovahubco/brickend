{# crud_template.j2
   Generates `app/crud/{{ entity.names.snake }}_crud.py` #}

from sqlalchemy.orm import Session
from app.models import {{ entity.names.pascal }}
from app.schemas import {{ entity.names.pascal }}Create
{% set first_field = entity.fields[0] %}
{% if first_field.type == 'uuid' %}from uuid import UUID
{% elif first_field.type == 'datetime' %}from datetime import datetime
{% endif %}

def get_{{ entity.names.snake }}(db: Session, id: {% if first_field.type == 'uuid' %}UUID{% elif first_field.type == 'string' %}str{% elif first_field.type == 'text' %}str{% elif first_field.type == 'integer' %}int{% elif first_field.type == 'float' %}float{% elif first_field.type == 'boolean' %}bool{% elif first_field.type == 'datetime' %}datetime{% else %}str{% endif %}):
    # Convert UUID to string for database comparison
    {% if first_field.type == 'uuid' -%}
    search_id = str(id)
    {%- else -%}
    search_id = id
    {%- endif %}
    return db.query({{ entity.names.pascal }}).filter(
        {{ entity.names.pascal }}.{{ entity.fields[0].names.snake }} == search_id
    ).first()

def get_{{ entity.names.snake }}_list(db: Session, skip: int = 0, limit: int = 100):
    return db.query({{ entity.names.pascal }}).offset(skip).limit(limit).all()

def create_{{ entity.names.snake }}(db: Session, obj_in: {{ entity.names.pascal }}Create):
    db_obj = {{ entity.names.pascal }}(**obj_in.model_dump())
    db.add(db_obj)
    db.commit()
    db.refresh(db_obj)
    return db_obj

def update_{{ entity.names.snake }}(
    db: Session, id: {% if first_field.type == 'uuid' %}UUID{% elif first_field.type == 'string' %}str{% elif first_field.type == 'text' %}str{% elif first_field.type == 'integer' %}int{% elif first_field.type == 'float' %}float{% elif first_field.type == 'boolean' %}bool{% elif first_field.type == 'datetime' %}datetime{% else %}str{% endif %}, obj_in: {{ entity.names.pascal }}Create
):
    db_obj = get_{{ entity.names.snake }}(db, id)
    if not db_obj:
        return None
    for field, value in obj_in.model_dump().items():
        setattr(db_obj, field, value)
    db.add(db_obj)
    db.commit()
    db.refresh(db_obj)
    return db_obj

def delete_{{ entity.names.snake }}(db: Session, id: {% if first_field.type == 'uuid' %}UUID{% elif first_field.type == 'string' %}str{% elif first_field.type == 'text' %}str{% elif first_field.type == 'integer' %}int{% elif first_field.type == 'float' %}float{% elif first_field.type == 'boolean' %}bool{% elif first_field.type == 'datetime' %}datetime{% else %}str{% endif %}):
    obj = get_{{ entity.names.snake }}(db, id)
    if obj:
        db.delete(obj)
        db.commit()
    return obj
